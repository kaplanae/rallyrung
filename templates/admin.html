{% extends "base.html" %}
{% block title %}Admin — {{ brand.APP_NAME }}{% endblock %}

{% block content %}
<h1 class="page-title">Admin Panel — {{ ladder_name }}</h1>

{% if disputed_count > 0 %}
<div class="flash error">{{ disputed_count }} disputed match{{ 'es' if disputed_count > 1 }} need review.</div>
{% endif %}

<!-- Monthly Actions -->
<div class="admin-section">
    <h2>Monthly Actions</h2>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <form method="POST" action="{{ url_for('admin_generate_groups') }}"
              onsubmit="return confirm('This will regenerate groups for the current month and delete any existing matches. Continue?')">
            <button type="submit" class="btn btn-primary">Generate Groups ({{ ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][month] }} {{ year }})</button>
        </form>
        <form method="POST" action="{{ url_for('admin_monthly_reset') }}"
              onsubmit="return confirm('This will finalize this month, apply ranking changes, and archive results. Continue?')">
            <button type="submit" class="btn btn-secondary">Run Monthly Reset</button>
        </form>
    </div>
</div>

<!-- Bulk Invite -->
<div class="admin-section">
    <h2>Bulk Invite Players</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
        Send login emails to all active ladder players who haven't logged in yet. Players who already received an invite will be skipped.
    </p>
    <form method="POST" action="{{ url_for('admin_bulk_invite') }}"
          onsubmit="return confirm('This will send welcome emails with login links to all players who haven\'t logged in yet. Continue?')">
        <button type="submit" class="btn btn-primary">Send Invite Emails</button>
    </form>
</div>

<!-- CSV Import -->
<div class="admin-section">
    <h2>Import Players from CSV</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
        CSV columns: Rank, Name, NTRP, Gender, Phone, Email
    </p>
    <form method="POST" action="{{ url_for('admin_import_csv') }}" enctype="multipart/form-data" style="display: flex; gap: 12px; align-items: center;">
        <input type="file" name="csv_file" accept=".csv" required
               style="color: var(--text-muted); font-size: 0.85rem;">
        <button type="submit" class="btn btn-primary btn-sm">Import</button>
    </form>
</div>

<!-- Ladder Players -->
<div class="admin-section">
    <h2>{{ ladder_name }} Rankings</h2>
    {% if ladder_players %}
    <table class="admin-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>NTRP</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lp in ladder_players %}
            <tr>
                <td>
                    <form method="POST" action="{{ url_for('admin_update_ranking') }}" style="display: flex; gap: 4px; align-items: center;">
                        <input type="hidden" name="user_id" value="{{ lp.user_id }}">
                        <input type="number" name="new_ranking" value="{{ lp.ranking }}" min="1"
                               style="width: 50px; padding: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); text-align: center; font-size: 0.85rem;">
                        <button type="submit" class="btn btn-secondary btn-sm" style="padding: 3px 8px;">Set</button>
                    </form>
                </td>
                <td>
                    {{ lp.username }}
                    {% if lp.has_logged_in %}<span class="badge badge-active" style="font-size: 0.65rem;">logged in</span>{% endif %}
                </td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ lp.email or "—" }}</td>
                <td style="font-size: 0.8rem;">{{ lp.phone or "—" }}</td>
                <td>{{ lp.ntrp_rating or "—" }}</td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <form method="POST" action="{{ url_for('admin_pause_player') }}" class="inline-form"
                          onsubmit="return confirm('Pause {{ lp.username }}? They will be removed from active play but keep their info.')">
                        <input type="hidden" name="user_id" value="{{ lp.user_id }}">
                        <button type="submit" class="btn btn-secondary btn-sm">Pause</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_remove_from_ladder') }}" class="inline-form"
                          onsubmit="return confirm('Remove {{ lp.username }} entirely from the ladder?')">
                        <input type="hidden" name="user_id" value="{{ lp.user_id }}">
                        <button type="submit" class="btn btn-sm" style="background: #e74c3c; color: #fff;">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state"><p>No players on the ladder yet.</p></div>
    {% endif %}
</div>

<!-- Pending Players -->
{% if pending_players %}
<div class="admin-section">
    <h2>Pending Players ({{ pending_players|length }})</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">These players will be added to the ladder at the next monthly reset.</p>
    <table class="admin-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>NTRP</th>
                <th>Signed Up</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for pp in pending_players %}
            <tr>
                <td>{{ pp.username }}</td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ pp.email or "—" }}</td>
                <td style="font-size: 0.8rem;">{{ pp.phone or "—" }}</td>
                <td>{{ pp.ntrp_rating or "—" }}</td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ (pp.joined_at|to_central).strftime('%b %d') if pp.joined_at else "—" }}</td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <form method="POST" action="{{ url_for('admin_remove_from_ladder') }}" class="inline-form"
                          onsubmit="return confirm('Remove {{ pp.username }} from pending?')">
                        <input type="hidden" name="user_id" value="{{ pp.user_id }}">
                        <button type="submit" class="btn btn-secondary btn-sm">Remove from Pending</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_delete_user') }}" class="inline-form"
                          onsubmit="return confirm('Delete {{ pp.username }} entirely? This removes the user account and cannot be undone.');">
                        <input type="hidden" name="user_id" value="{{ pp.user_id }}">
                        <button type="submit" class="btn btn-sm" style="background: #e74c3c; color: #fff;">Delete User</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Paused Players -->
{% if paused_players %}
<div class="admin-section">
    <h2>Paused Players ({{ paused_players|length }})</h2>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">These players are paused — not in active play but their info is preserved.</p>
    <table class="admin-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>NTRP</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for pp in paused_players %}
            <tr>
                <td>{{ pp.username }}</td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ pp.email or "—" }}</td>
                <td style="font-size: 0.8rem;">{{ pp.phone or "—" }}</td>
                <td>{{ pp.ntrp_rating or "—" }}</td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <form method="POST" action="{{ url_for('admin_pause_player') }}" class="inline-form">
                        <input type="hidden" name="user_id" value="{{ pp.user_id }}">
                        <button type="submit" class="btn btn-primary btn-sm">Unpause</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_remove_from_ladder') }}" class="inline-form"
                          onsubmit="return confirm('Remove {{ pp.username }} entirely?')">
                        <input type="hidden" name="user_id" value="{{ pp.user_id }}">
                        <button type="submit" class="btn btn-sm" style="background: #e74c3c; color: #fff;">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- All Users -->
<div class="admin-section">
    <h2>All Users</h2>
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in all_users %}
            <tr>
                <td>{{ u.id }}</td>
                <td>
                    {{ u.username }}
                    {% if u.is_admin %}<span class="badge badge-admin">admin</span>{% endif %}
                    {% if u.has_logged_in %}<span class="badge badge-active" style="font-size: 0.65rem;">logged in</span>{% endif %}
                </td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ u.email or "—" }}</td>
                <td>
                    {% if u.ladder_status == 'active' %}
                        <span class="badge badge-active">active</span>
                    {% elif u.ladder_status == 'pending' %}
                        <span class="badge" style="background: rgba(241, 196, 15, 0.15); color: #f1c40f;">pending</span>
                    {% elif u.ladder_status == 'paused' %}
                        <span class="badge badge-inactive">paused</span>
                    {% else %}
                        <span class="badge badge-inactive">inactive</span>
                    {% endif %}
                </td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <form method="POST" action="{{ url_for('admin_toggle_admin') }}" class="inline-form">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <button type="submit" class="btn btn-secondary btn-sm">
                            {{ "Remove Admin" if u.is_admin else "Make Admin" }}
                        </button>
                    </form>
                    {% if u.email %}
                    <form method="POST" action="{{ url_for('admin_generate_login_link') }}" class="inline-form">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <button type="submit" class="btn btn-primary btn-sm">Login Link</button>
                    </form>
                    {% endif %}
                    {% if not u.is_admin %}
                    <form method="POST" action="{{ url_for('admin_delete_user') }}" class="inline-form" onsubmit="return confirm('Delete {{ u.username }}? This cannot be undone.');">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <button type="submit" class="btn btn-sm" style="background: #e74c3c; color: #fff;">Delete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
