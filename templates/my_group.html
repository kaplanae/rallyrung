{% extends "base.html" %}
{% block title %}My Group — RallyRung{% endblock %}

{% block content %}
<h1 class="page-title">My Group</h1>

{% if not group %}
<div class="empty-state">
    <p>You're not assigned to a group this month.</p>
    <p>Groups are generated by the admin at the start of each month.</p>
</div>
{% else %}

<div class="card">
    <h3 style="color: var(--accent); margin-bottom: 16px;">Group {{ group.group_number }} — Your Opponents</h3>

    {% for p in group_players %}
    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);">
        {% if p.profile_picture %}
            <img src="{{ p.profile_picture }}" alt="" style="width: 36px; height: 36px; border-radius: 50%;">
        {% endif %}
        <div style="flex: 1;">
            <div style="font-weight: 600;">
                {{ p.username }}
                {% if p.id == current_user.id %}<span style="color: var(--text-muted);">(you)</span>{% endif %}
                {% if p.ntrp_rating %}<span class="ntrp-badge" style="margin-left: 8px;">{{ p.ntrp_rating }}</span>{% endif %}
            </div>
            <div class="contact-info">
                {% if p.email %}{{ p.email }}{% endif %}
                {% if p.phone %} &middot; {{ p.phone }}{% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin: 24px 0 16px;">
    <h2 class="section-title" style="margin: 0;">Matches</h2>
    <a href="{{ url_for('submit_result') }}" class="btn btn-primary btn-sm">Submit Result</a>
</div>

{% if matches %}
    {% for m in matches %}
    <div class="match-card">
        <div class="match-header">
            <span class="match-players">{{ m.p1_name }} vs {{ m.p2_name }}</span>
            <span class="match-status status-{{ m.status }}">{{ m.status }}</span>
        </div>
        <div class="match-scores">
            {% if m.set1_p1 is not none %}
                <span class="set-score">{{ m.set1_p1 }}-{{ m.set1_p2 }}</span>
            {% endif %}
            {% if m.set2_p1 is not none %}
                <span class="set-score">{{ m.set2_p1 }}-{{ m.set2_p2 }}</span>
            {% endif %}
            {% if m.set3_p1 is not none %}
                <span class="set-score">{{ m.set3_p1 }}-{{ m.set3_p2 }}</span>
            {% endif %}
            {% if m.winner_name %}
                <span style="margin-left: 8px; color: var(--accent); font-weight: 600;">Winner: {{ m.winner_name }}</span>
            {% endif %}
        </div>

        {% if m.status == 'pending' %}
        <div class="match-actions">
            {% if m.submitted_by != current_user.id and (m.player1_id == current_user.id or m.player2_id == current_user.id) %}
                <form action="{{ url_for('confirm_match', match_id=m.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-primary btn-sm">Confirm</button>
                </form>
                <form action="{{ url_for('dispute_match', match_id=m.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-danger btn-sm">Dispute</button>
                </form>
            {% endif %}
            {% if m.submitted_by == current_user.id %}
                <form action="{{ url_for('delete_match', match_id=m.id) }}" method="POST" class="inline-form"
                      onsubmit="return confirm('Delete this submission?')">
                    <button type="submit" class="btn btn-secondary btn-sm">Delete</button>
                </form>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Waiting for opponent to confirm</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <p>No matches yet. Submit your first result!</p>
    </div>
{% endif %}

{% if standings %}
<h2 class="section-title" style="margin-top: 32px;">Group Standings</h2>
<div class="card">
    <table class="ladder-table">
        <thead>
            <tr>
                <th>Player</th>
                <th>W</th>
                <th>L</th>
                <th>Games +/-</th>
            </tr>
        </thead>
        <tbody>
            {% for p in group_players %}
            {% if p.id in standings %}
            <tr>
                <td>{{ p.username }}</td>
                <td>{{ standings[p.id].wins }}</td>
                <td>{{ standings[p.id].losses }}</td>
                <td>{{ standings[p.id].games_won }}-{{ standings[p.id].games_lost }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endif %}
{% endblock %}
