{% extends "base.html" %}
{% block title %}My Group — RallyRung{% endblock %}

{% block content %}
<h1 class="page-title">My Group</h1>

{% if not group %}
<div class="empty-state">
    <p>You're not assigned to a group this month.</p>
    <p>Groups are generated by the admin at the start of each month.</p>
</div>
{% else %}

<div class="card">
    <h3 style="color: var(--accent); margin-bottom: 16px;">Group {{ group.group_number }} — Your Opponents</h3>

    {% for p in group_players %}
    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);">
        {% if p.profile_picture %}
            <img src="{{ p.profile_picture }}" alt="" style="width: 36px; height: 36px; border-radius: 50%;">
        {% endif %}
        <div style="flex: 1;">
            <div style="font-weight: 600;">
                {{ p.username }}
                {% if p.id == current_user.id %}<span style="color: var(--text-muted);">(you)</span>{% endif %}
                {% if p.ntrp_rating %}<span class="ntrp-badge" style="margin-left: 8px;">{{ p.ntrp_rating }}</span>{% endif %}
            </div>
            <div class="contact-info">
                {% if p.email %}{{ p.email }}{% endif %}
                {% if p.phone %} &middot; {{ p.phone }}{% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Scheduling Section -->
<h2 class="section-title" style="margin-top: 32px;">Schedule a Match</h2>

{% if bookings %}
<div class="card" style="margin-bottom: 16px;">
    <div class="card-header"><h3>Upcoming Bookings</h3></div>
    {% for b in bookings %}
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
        <div>
            <strong>{{ b.requester_name }}</strong> vs <strong>{{ b.opponent_name }}</strong><br>
            <span style="color: var(--text-muted); font-size: 0.85rem;">
                {{ b.match_date }} &middot; {{ b.start_hour|format_hour }} &ndash; {{ b.end_hour|format_hour }}
            </span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            {% if b.status == 'confirmed' %}
                <span class="badge badge-active">confirmed</span>
            {% elif b.status == 'pending' %}
                <span class="badge" style="background: rgba(241, 196, 15, 0.15); color: #f1c40f;">pending</span>
                {% if b.opponent_id == current_user.id %}
                    <form method="POST" action="{{ url_for('booking_confirm', booking_id=b.id) }}" class="inline-form">
                        <button type="submit" class="btn btn-primary btn-sm">Confirm</button>
                    </form>
                    <form method="POST" action="{{ url_for('booking_decline', booking_id=b.id) }}" class="inline-form">
                        <button type="submit" class="btn btn-secondary btn-sm">Decline</button>
                    </form>
                {% endif %}
                {% if b.requester_id == current_user.id %}
                    <form method="POST" action="{{ url_for('booking_cancel', booking_id=b.id) }}" class="inline-form">
                        <button type="submit" class="btn btn-secondary btn-sm">Cancel</button>
                    </form>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Waiting for confirmation</span>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% for opp_id in opponent_ids %}
<div class="card" style="margin-bottom: 16px;">
    <div class="card-header">
        <h3>{{ opponent_names[opp_id] }}</h3>
    </div>

    {# Show opponent's availability #}
    {% if availability.get(opp_id) %}
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Their availability:</p>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px;">
            {% for a in availability[opp_id] %}
                <span style="background: var(--bg); padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border);">
                    {{ a.date_display }} {{ a.start_hour|format_hour }}&ndash;{{ a.end_hour|format_hour }}
                </span>
            {% endfor %}
        </div>
    {% else %}
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
            No availability set. Ask them to update their <a href="{{ url_for('availability') }}" style="color: var(--accent);">availability</a>.
        </p>
    {% endif %}

    {# Show bookable slots #}
    {% set slots = opponent_slots.get(opp_id, []) %}
    {% if slots %}
        {% if availability.get(opp_id) and availability.get(current_user.id) %}
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Available 2-hour slots (overlapping times):</p>
        {% elif availability.get(opp_id) %}
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Book from their availability:</p>
        {% else %}
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Book from your availability:</p>
        {% endif %}
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="ladder-table" style="font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% set current_date = namespace(val='') %}
                    {% for s in slots %}
                    <tr>
                        <td style="font-weight: {{ '600' if s.date != current_date.val else '400' }};">
                            {% if s.date != current_date.val %}
                                {{ s.date_display }}
                                {% set current_date.val = s.date %}
                            {% endif %}
                        </td>
                        <td>{{ s.start_hour|format_hour }} &ndash; {{ s.end_hour|format_hour }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('book_match') }}" class="inline-form">
                                <input type="hidden" name="opponent_id" value="{{ opp_id }}">
                                <input type="hidden" name="match_date" value="{{ s.date }}">
                                <input type="hidden" name="start_hour" value="{{ s.start_hour }}">
                                <button type="submit" class="btn btn-primary btn-sm" style="padding: 3px 12px;">Book</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif availability.get(opp_id) and availability.get(current_user.id) %}
        <p style="font-size: 0.85rem; color: var(--text-muted);">No overlapping times found this month.</p>
    {% elif not availability.get(current_user.id) and not availability.get(opp_id) %}
        <p style="font-size: 0.85rem; color: var(--text-muted);">
            Neither of you has set <a href="{{ url_for('availability') }}" style="color: var(--accent);">availability</a> yet.
        </p>
    {% endif %}
</div>
{% endfor %}

<div style="display: flex; justify-content: space-between; align-items: center; margin: 32px 0 16px;">
    <h2 class="section-title" style="margin: 0;">Matches</h2>
    <a href="{{ url_for('submit_result') }}" class="btn btn-primary btn-sm">Submit Result</a>
</div>

{% if matches %}
    {% for m in matches %}
    <div class="match-card">
        <div class="match-header">
            <span class="match-players">
                {% if m.winner_id == m.player1_id %}<strong>{{ m.p1_name }}</strong>{% else %}{{ m.p1_name }}{% endif %}
                vs
                {% if m.winner_id == m.player2_id %}<strong>{{ m.p2_name }}</strong>{% else %}{{ m.p2_name }}{% endif %}
            </span>
            <span class="match-status status-{{ m.status }}">{{ m.status }}</span>
            {% if m.outcome_type and m.outcome_type != 'completed' %}
                <span class="badge" style="background: rgba(155, 89, 182, 0.15); color: #9b59b6; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; margin-left: 6px;">
                    {{ m.outcome_type | replace('_', ' ') }}
                </span>
            {% endif %}
        </div>
        <div class="match-scores">
            {% if m.outcome_type in ('schedule_problem', 'weather_problem') %}
                <span style="color: var(--text-muted); font-style: italic;">No winner</span>
            {% elif m.outcome_type in ('forfeit', 'injury_not_played') %}
                {% if m.winner_name %}
                    <span style="color: var(--accent); font-weight: 600;">Winner: {{ m.winner_name }}</span>
                {% endif %}
            {% else %}
                {% if m.set1_p1 is not none %}
                    <span class="set-score">{{ m.set1_p1 }}-{{ m.set1_p2 }}</span>
                {% endif %}
                {% if m.set2_p1 is not none %}
                    <span class="set-score">{{ m.set2_p1 }}-{{ m.set2_p2 }}</span>
                {% endif %}
                {% if m.set3_p1 is not none %}
                    <span class="set-score">{{ m.set3_p1 }}-{{ m.set3_p2 }}</span>
                {% endif %}
                {% if m.winner_name %}
                    <span style="margin-left: 8px; color: var(--accent); font-weight: 600;">Winner: {{ m.winner_name }}</span>
                {% endif %}
            {% endif %}
        </div>

        {% if m.status == 'pending' %}
        <div class="match-actions">
            {% if m.submitted_by != current_user.id and (m.player1_id == current_user.id or m.player2_id == current_user.id) %}
                <form action="{{ url_for('confirm_match', match_id=m.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-primary btn-sm">Confirm</button>
                </form>
                <form action="{{ url_for('dispute_match', match_id=m.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-danger btn-sm">Dispute</button>
                </form>
            {% endif %}
            {% if m.submitted_by == current_user.id %}
                <form action="{{ url_for('delete_match', match_id=m.id) }}" method="POST" class="inline-form"
                      onsubmit="return confirm('Delete this submission?')">
                    <button type="submit" class="btn btn-secondary btn-sm">Delete</button>
                </form>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Waiting for opponent to confirm</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <p>No matches yet. Submit your first result!</p>
    </div>
{% endif %}

{% if standings %}
<h2 class="section-title" style="margin-top: 32px;">Group Standings</h2>
<div class="card">
    <table class="ladder-table">
        <thead>
            <tr>
                <th>Player</th>
                <th>W</th>
                <th>L</th>
                <th>Games +/-</th>
            </tr>
        </thead>
        <tbody>
            {% for p in group_players %}
            {% if p.id in standings %}
            <tr>
                <td>{{ p.username }}</td>
                <td>{{ standings[p.id].wins }}</td>
                <td>{{ standings[p.id].losses }}</td>
                <td>{{ standings[p.id].games_won }}-{{ standings[p.id].games_lost }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endif %}
{% endblock %}
