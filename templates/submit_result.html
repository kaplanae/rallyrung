{% extends "base.html" %}
{% block title %}Submit Result — RallyRung{% endblock %}

{% block content %}
<h1 class="page-title">Submit Match Result</h1>

<div class="card">
    <form method="POST" action="{{ url_for('submit_result') }}" id="result-form">
        <div class="form-group">
            <label>Opponent</label>
            <select name="opponent_id" required>
                <option value="">Select opponent...</option>
                {% for opp in opponents %}
                    <option value="{{ opp.id }}">{{ opp.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Match Outcome</label>
            <select name="outcome_type" required id="outcome-type">
                <option value="completed">Completed (normal match)</option>
                <option value="forfeit">Forfeit (opponent didn't show)</option>
                <option value="injury_not_played">Injury — match not played</option>
                <option value="injury_not_finished">Injury — match not finished</option>
                <option value="schedule_problem">Scheduling problem (no winner)</option>
                <option value="weather_problem">Weather problem (no winner)</option>
            </select>
        </div>

        <div class="form-group" id="winner-group">
            <label>Winner</label>
            <select name="winner_id" id="winner-select">
                <option value="">Select winner...</option>
                <option value="{{ current_user.id }}">Me ({{ current_user.username }})</option>
                {% for opp in opponents %}
                    <option value="{{ opp.id }}">{{ opp.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="margin: 20px 0;" id="scores-section">
            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                Set Scores <span style="font-weight: 400; text-transform: none;">(your score first)</span>
            </label>

            <div id="set-status" style="margin-bottom: 12px; font-size: 0.9rem; color: var(--accent); font-weight: 600; display: none;"></div>

            <div class="set-score-row" id="set1-row">
                <label>Set 1</label>
                <input type="text" inputmode="numeric" pattern="[0-7]" maxlength="1" name="set1_p1" placeholder="You" autocomplete="off">
                <span class="dash">—</span>
                <input type="text" inputmode="numeric" pattern="[0-7]" maxlength="1" name="set1_p2" placeholder="Opp" autocomplete="off">
                <span class="set-validation" style="font-size: 0.8rem; margin-left: 8px;"></span>
            </div>
            <div class="set-tb-row" id="set1-tb-row" style="display: none; margin-left: 58px; margin-bottom: 10px;">
                <label style="font-size: 0.8rem; color: var(--text-muted); margin-right: 8px;">TB:</label>
                <input type="text" inputmode="numeric" maxlength="2" name="set1_tb_you" placeholder="You" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <span class="dash" style="margin: 0 4px;">-</span>
                <input type="text" inputmode="numeric" maxlength="2" name="set1_tb_opp" placeholder="Opp" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <input type="hidden" name="set1_tb">
            </div>

            <div class="set-score-row" id="set2-row">
                <label>Set 2</label>
                <input type="text" inputmode="numeric" pattern="[0-7]" maxlength="1" name="set2_p1" placeholder="You" autocomplete="off">
                <span class="dash">—</span>
                <input type="text" inputmode="numeric" pattern="[0-7]" maxlength="1" name="set2_p2" placeholder="Opp" autocomplete="off">
                <span class="set-validation" style="font-size: 0.8rem; margin-left: 8px;"></span>
                <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 4px;">or 1-0 for tiebreak</span>
            </div>
            <div class="set-tb-row" id="set2-tb-row" style="display: none; margin-left: 58px; margin-bottom: 10px;">
                <label style="font-size: 0.8rem; color: var(--text-muted); margin-right: 8px;">TB:</label>
                <input type="text" inputmode="numeric" maxlength="2" name="set2_tb_you" placeholder="You" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <span class="dash" style="margin: 0 4px;">-</span>
                <input type="text" inputmode="numeric" maxlength="2" name="set2_tb_opp" placeholder="Opp" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <input type="hidden" name="set2_tb">
            </div>

            <div class="set-score-row" id="set3-row" style="display: none;">
                <label>Set 3</label>
                <input type="text" inputmode="numeric" pattern="[01]" maxlength="1" name="set3_p1" placeholder="You" autocomplete="off">
                <span class="dash">—</span>
                <input type="text" inputmode="numeric" pattern="[01]" maxlength="1" name="set3_p2" placeholder="Opp" autocomplete="off">
                <span class="set-validation" style="font-size: 0.8rem; margin-left: 8px;"></span>
                <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 4px;">1-0 or 0-1</span>
            </div>
            <div class="set-tb-row" id="set3-tb-row" style="display: none; margin-left: 58px; margin-bottom: 10px;">
                <label style="font-size: 0.8rem; color: var(--text-muted); margin-right: 8px;">TB:</label>
                <input type="text" inputmode="numeric" maxlength="2" name="set3_tb_you" placeholder="You" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <span class="dash" style="margin: 0 4px;">-</span>
                <input type="text" inputmode="numeric" maxlength="2" name="set3_tb_opp" placeholder="Opp" autocomplete="off" style="width: 45px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                <input type="hidden" name="set3_tb">
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button type="submit" class="btn btn-primary">Submit Result</button>
            <a href="{{ url_for('my_group') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const outcomeSelect = document.getElementById('outcome-type');
const winnerGroup = document.getElementById('winner-group');
const winnerSelect = document.getElementById('winner-select');
const scoresSection = document.getElementById('scores-section');
const set1Row = document.getElementById('set1-row');
const set2Row = document.getElementById('set2-row');
const set3Row = document.getElementById('set3-row');
const set1TbRow = document.getElementById('set1-tb-row');
const set2TbRow = document.getElementById('set2-tb-row');
const set3TbRow = document.getElementById('set3-tb-row');
const setStatus = document.getElementById('set-status');

const myId = '{{ current_user.id }}';
const myName = '{{ current_user.username }}';
const opponents = { {% for opp in opponents %}'{{ opp.id }}': '{{ opp.username }}'{% if not loop.last %}, {% endif %}{% endfor %} };

const VALID_SCORES = [
    [6,0],[6,1],[6,2],[6,3],[6,4],[7,5],[7,6],
    [0,6],[1,6],[2,6],[3,6],[4,6],[5,7],[6,7]
];

function isValidSet(a, b) {
    return VALID_SCORES.some(v => v[0] === a && v[1] === b);
}

function isValidSet2(a, b) {
    // Set 2 also allows 1-0 / 0-1 (match tiebreak in lieu of full set)
    if ((a === 1 && b === 0) || (a === 0 && b === 1)) return true;
    return isValidSet(a, b);
}

function isMatchTiebreakSet(a, b) {
    // 1-0 or 0-1 means match tiebreak played instead of full set
    return (a === 1 && b === 0) || (a === 0 && b === 1);
}

function isValidTiebreak(a, b) {
    if (a < 0 || b < 0) return false;
    const high = Math.max(a, b), low = Math.min(a, b);
    const diff = high - low;
    if (diff < 2) return false;
    // 10-point match tiebreak
    if (high === 10 && low <= 8) return true;
    if (high > 10 && low === high - 2 && low >= 9) return true;
    // 7-point match tiebreak
    if (high === 7 && low <= 5) return true;
    if (high > 7 && high < 10 && low === high - 2 && low >= 6) return true;
    return false;
}

function isSetTiebreak(a, b) {
    // 7-6 or 6-7
    return (a === 7 && b === 6) || (a === 6 && b === 7);
}

function getSetScores(setNum) {
    const p1 = document.querySelector(`[name="set${setNum}_p1"]`).value.trim();
    const p2 = document.querySelector(`[name="set${setNum}_p2"]`).value.trim();
    if (p1 === '' || p2 === '') return null;
    return [parseInt(p1), parseInt(p2)];
}

function youWonSet(scores) {
    return scores[0] > scores[1];
}

function getWinnerName() {
    const wid = winnerSelect.value;
    if (!wid) return null;
    if (wid === myId) return myName;
    return opponents[wid] || null;
}

function getWinnerId() {
    return winnerSelect.value || null;
}

function syncTbHidden(setNum) {
    const you = document.querySelector(`[name="set${setNum}_tb_you"]`).value.trim();
    const opp = document.querySelector(`[name="set${setNum}_tb_opp"]`).value.trim();
    document.querySelector(`[name="set${setNum}_tb"]`).value = (you && opp) ? `${you}-${opp}` : '';
}

function updateScores() {
    const outcome = outcomeSelect.value;
    if (outcome !== 'completed') return;

    const winnerId = getWinnerId();
    const winnerIsMe = winnerId === myId;

    const s1 = getSetScores(1);
    const s2 = getSetScores(2);

    // Validate set 1
    const v1 = set1Row.querySelector('.set-validation');
    if (s1) {
        if (isValidSet(s1[0], s1[1])) {
            v1.textContent = '✓';
            v1.style.color = '#2ecc71';
            if (isSetTiebreak(s1[0], s1[1])) {
                set1TbRow.style.display = 'flex';
                set1TbRow.style.alignItems = 'center';
            } else {
                set1TbRow.style.display = 'none';
                set1TbRow.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
                document.querySelector('[name="set1_tb"]').value = '';
            }
        } else {
            v1.textContent = 'Invalid';
            v1.style.color = '#e74c3c';
            set1TbRow.style.display = 'none';
        }
    } else {
        v1.textContent = '';
        set1TbRow.style.display = 'none';
    }

    // Validate set 2 (also allows 1-0/0-1 for match tiebreak in lieu of set)
    const v2 = set2Row.querySelector('.set-validation');
    const set2IsTiebreak = s2 && isMatchTiebreakSet(s2[0], s2[1]);
    if (s2) {
        if (isValidSet2(s2[0], s2[1])) {
            v2.textContent = '✓';
            v2.style.color = '#2ecc71';
            if (isSetTiebreak(s2[0], s2[1]) || set2IsTiebreak) {
                // Show TB input for 7-6 (set TB) or 1-0 (match TB)
                set2TbRow.style.display = 'flex';
                set2TbRow.style.alignItems = 'center';
            } else {
                set2TbRow.style.display = 'none';
                set2TbRow.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
                document.querySelector('[name="set2_tb"]').value = '';
            }
        } else {
            v2.textContent = 'Invalid';
            v2.style.color = '#e74c3c';
            set2TbRow.style.display = 'none';
        }
    } else {
        v2.textContent = '';
        set2TbRow.style.display = 'none';
    }

    // Show set status and decide if match tiebreak (set 3) is needed
    const s1Valid = s1 && isValidSet(s1[0], s1[1]);
    const s2Valid = s2 && isValidSet2(s2[0], s2[1]);

    if (s1Valid && s2Valid) {
        const winnerName = getWinnerName();

        if (set2IsTiebreak) {
            // 1-0 means match tiebreak played instead of full 2nd set — match is decided
            set3Row.style.display = 'none';
            set3TbRow.style.display = 'none';
            set3Row.querySelectorAll('input').forEach(inp => inp.value = '');
            set3TbRow.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
            document.querySelector('[name="set3_tb"]') && (document.querySelector('[name="set3_tb"]').value = '');
            set3Row.querySelector('.set-validation').textContent = '';
            if (winnerName) {
                setStatus.textContent = `${winnerName} wins 2-0 (match tiebreak)`;
                setStatus.style.display = '';
            }
        } else {
            const mySetWins = (youWonSet(s1) ? 1 : 0) + (youWonSet(s2) ? 1 : 0);
            const oppSetWins = 2 - mySetWins;

            if (mySetWins === 1 && oppSetWins === 1) {
                // Split — show set 3 (1-0 / 0-1 only)
                set3Row.style.display = '';
                setStatus.textContent = 'Sets tied 1-1 — enter 1-0 or 0-1 for match tiebreak';
                setStatus.style.display = '';

                const s3 = getSetScores(3);
                const v3 = set3Row.querySelector('.set-validation');
                if (s3) {
                    if (isMatchTiebreakSet(s3[0], s3[1])) {
                        v3.textContent = '✓';
                        v3.style.color = '#2ecc71';
                        // Show TB detail row
                        set3TbRow.style.display = 'flex';
                        set3TbRow.style.alignItems = 'center';

                        // Check if TB score is filled and valid
                        const tbVal = document.querySelector('[name="set3_tb"]').value;
                        if (tbVal && winnerName) {
                            const parts = tbVal.split('-');
                            if (parts.length === 2) {
                                const tbA = parseInt(parts[0]), tbB = parseInt(parts[1]);
                                if (isValidTiebreak(tbA, tbB)) {
                                    const finalMyWins = mySetWins + (youWonSet(s3) ? 1 : 0);
                                    const finalOppWins = oppSetWins + (youWonSet(s3) ? 0 : 1);
                                    setStatus.textContent = `${winnerName} wins ${winnerIsMe ? finalMyWins : finalOppWins}-${winnerIsMe ? finalOppWins : finalMyWins}`;
                                }
                            }
                        }
                    } else {
                        v3.textContent = 'Must be 1-0 or 0-1';
                        v3.style.color = '#e74c3c';
                        set3TbRow.style.display = 'none';
                    }
                } else {
                    v3.textContent = '';
                    set3TbRow.style.display = 'none';
                }
            } else {
                // Straight sets — hide match tiebreak
                set3Row.style.display = 'none';
                set3TbRow.style.display = 'none';
                set3Row.querySelectorAll('input').forEach(inp => inp.value = '');
                set3TbRow.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
                document.querySelector('[name="set3_tb"]') && (document.querySelector('[name="set3_tb"]').value = '');
                set3Row.querySelector('.set-validation').textContent = '';

                if (winnerName) {
                    setStatus.textContent = `${winnerName} wins ${Math.max(mySetWins, oppSetWins)}-${Math.min(mySetWins, oppSetWins)}`;
                    setStatus.style.display = '';
                }
            }
        }
    } else {
        set3Row.style.display = 'none';
        set3TbRow.style.display = 'none';
        set3Row.querySelectorAll('input').forEach(inp => inp.value = '');
        set3TbRow.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
        document.querySelector('[name="set3_tb"]') && (document.querySelector('[name="set3_tb"]').value = '');
        set3Row.querySelector('.set-validation').textContent = '';
        setStatus.style.display = 'none';
    }
}

function updateFormState() {
    const outcome = outcomeSelect.value;

    winnerGroup.style.display = '';
    winnerSelect.required = true;
    scoresSection.style.display = '';
    set3Row.style.display = 'none';
    set1TbRow.style.display = 'none';
    set2TbRow.style.display = 'none';
    set3TbRow.style.display = 'none';
    setStatus.style.display = 'none';

    if (outcome === 'completed') {
        updateScores();
    } else if (outcome === 'forfeit' || outcome === 'injury_not_played') {
        scoresSection.style.display = 'none';
        scoresSection.querySelectorAll('input').forEach(inp => inp.value = '');
    } else if (outcome === 'injury_not_finished') {
        set3Row.style.display = '';
    } else if (outcome === 'schedule_problem' || outcome === 'weather_problem') {
        winnerGroup.style.display = 'none';
        winnerSelect.required = false;
        winnerSelect.value = '';
        scoresSection.style.display = 'none';
        scoresSection.querySelectorAll('input').forEach(inp => inp.value = '');
    }
}

outcomeSelect.addEventListener('change', updateFormState);
winnerSelect.addEventListener('change', updateScores);

// Listen on all score inputs (sets) — all are max 1 digit now
document.querySelectorAll('.set-score-row input').forEach(inp => {
    inp.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 1);
        updateScores();
    });
});

// Listen on tiebreak detail inputs
document.querySelectorAll('.set-tb-row input[type="text"]').forEach(inp => {
    inp.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2);
        const setNum = this.closest('#set1-tb-row') ? 1 : (this.closest('#set2-tb-row') ? 2 : 3);
        syncTbHidden(setNum);
        updateScores();
    });
});

updateFormState();

document.getElementById('result-form').addEventListener('submit', function(e) {
    const outcome = outcomeSelect.value;

    if (outcome === 'completed') {
        const winnerId = getWinnerId();
        const winnerIsMe = winnerId === myId;

        if (!winnerId) {
            alert('Please select a winner.');
            e.preventDefault();
            return;
        }

        const s1 = getSetScores(1);
        const s2 = getSetScores(2);

        if (!s1 || !s2) {
            alert('Please enter scores for both sets.');
            e.preventDefault();
            return;
        }

        if (!isValidSet(s1[0], s1[1])) {
            alert(`Set 1 score ${s1[0]}-${s1[1]} is not valid.\n\nWin to 6 (up to 6-4), 7-5, or 7-6.`);
            e.preventDefault();
            return;
        }

        if (!isValidSet2(s2[0], s2[1])) {
            alert(`Set 2 score ${s2[0]}-${s2[1]} is not valid.\n\nWin to 6 (up to 6-4), 7-5, 7-6, or 1-0 for match tiebreak.`);
            e.preventDefault();
            return;
        }

        const s2IsTB = isMatchTiebreakSet(s2[0], s2[1]);

        if (s2IsTB) {
            // Match tiebreak in lieu of full 2nd set — validate TB score in set2_tb
            const tbVal = document.querySelector('[name="set2_tb"]').value;
            if (tbVal) {
                const parts = tbVal.split('-');
                if (parts.length === 2) {
                    const tbA = parseInt(parts[0]), tbB = parseInt(parts[1]);
                    if (!isValidTiebreak(tbA, tbB)) {
                        alert(`Tiebreak score ${tbA}-${tbB} is not valid.\n\nFirst to 10 (or 7), win by 2.`);
                        e.preventDefault();
                        return;
                    }
                }
            }
            // Winner must have won set 1 + tiebreak (both)
            const winnerWonS1 = winnerIsMe ? youWonSet(s1) : !youWonSet(s1);
            const winnerWonTB = winnerIsMe ? (s2[0] === 1) : (s2[1] === 1);
            if (!winnerWonS1 && !winnerWonTB) {
                const winnerName = getWinnerName();
                alert(`${winnerName} didn't win either the set or the tiebreak. Check your scores or change the winner.`);
                e.preventDefault();
                return;
            }
        } else {
            const mySet1 = youWonSet(s1);
            const mySet2 = youWonSet(s2);
            let mySetWins = (mySet1 ? 1 : 0) + (mySet2 ? 1 : 0);
            let oppSetWins = 2 - mySetWins;

            if (mySetWins === 1 && oppSetWins === 1) {
                const s3 = getSetScores(3);
                if (!s3) {
                    alert('Sets are split 1-1 — please enter 1-0 or 0-1 for the match tiebreak.');
                    e.preventDefault();
                    return;
                }
                if (!isMatchTiebreakSet(s3[0], s3[1])) {
                    alert('Set 3 must be 1-0 or 0-1 (match tiebreak).');
                    e.preventDefault();
                    return;
                }
                // Validate TB detail score
                const tb3Val = document.querySelector('[name="set3_tb"]').value;
                if (!tb3Val) {
                    alert('Please enter the tiebreak score for set 3.');
                    e.preventDefault();
                    return;
                }
                const tb3Parts = tb3Val.split('-');
                if (tb3Parts.length === 2) {
                    const tb3A = parseInt(tb3Parts[0]), tb3B = parseInt(tb3Parts[1]);
                    if (!isValidTiebreak(tb3A, tb3B)) {
                        alert(`Tiebreak score ${tb3A}-${tb3B} is not valid.\n\nFirst to 10 (or 7), win by 2.`);
                        e.preventDefault();
                        return;
                    }
                }
                mySetWins += youWonSet(s3) ? 1 : 0;
                oppSetWins += youWonSet(s3) ? 0 : 1;
            }

            // Check winner matches set results
            const winnerSetsWon = winnerIsMe ? mySetWins : oppSetWins;
            if (winnerSetsWon < 2) {
                const winnerName = getWinnerName();
                alert(`${winnerName} only won ${winnerSetsWon} set(s) — the winner must win 2 sets. Check your scores or change the winner.`);
                e.preventDefault();
                return;
            }
        }

        // Sync tiebreak hidden fields before submit
        syncTbHidden(1);
        syncTbHidden(2);
        syncTbHidden(3);
    }

    if (outcome === 'injury_not_finished') {
        for (let i = 1; i <= 3; i++) {
            const p1 = document.querySelector(`[name="set${i}_p1"]`).value;
            const p2 = document.querySelector(`[name="set${i}_p2"]`).value;
            if ((p1 !== '' && p2 === '') || (p1 === '' && p2 !== '')) {
                alert(`Set ${i}: Both scores must be filled or both empty.`);
                e.preventDefault();
                return;
            }
        }
    }
});
</script>
{% endblock %}
